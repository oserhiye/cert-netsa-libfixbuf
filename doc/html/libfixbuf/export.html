<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
    Copyright (C) 2006-2024 Carnegie Mellon University
    See license information in LICENSE.txt.
-->
<!--
    @DISTRIBUTION_STATEMENT_BEGIN@
    libfixbuf 2.5
    Copyright 2024 Carnegie Mellon University.
    NO WARRANTY. THIS CARNEGIE MELLON UNIVERSITY AND SOFTWARE ENGINEERING
    INSTITUTE MATERIAL IS FURNISHED ON AN "AS-IS" BASIS. CARNEGIE MELLON
    UNIVERSITY MAKES NO WARRANTIES OF ANY KIND, EITHER EXPRESSED OR
    IMPLIED, AS TO ANY MATTER INCLUDING, BUT NOT LIMITED TO, WARRANTY OF
    FITNESS FOR PURPOSE OR MERCHANTABILITY, EXCLUSIVITY, OR RESULTS
    OBTAINED FROM USE OF THE MATERIAL. CARNEGIE MELLON UNIVERSITY DOES NOT
    MAKE ANY WARRANTY OF ANY KIND WITH RESPECT TO FREEDOM FROM PATENT,
    TRADEMARK, OR COPYRIGHT INFRINGEMENT.
    Licensed under a GNU-Lesser GPL 3.0-style license, please see
    LICENSE.txt or contact permission@sei.cmu.edu for full terms.
    [DISTRIBUTION STATEMENT A] This material has been approved for public
    release and unlimited distribution.  Please see Copyright notice for
    non-US Government use and distribution.
    This Software includes and/or makes use of Third-Party Software each
    subject to its own license.
    DM24-1020
    @DISTRIBUTION_STATEMENT_END@
-->
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libfixbuf: Exporter Usage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Exporter Usage</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>How-To Export IPFIX</p>
<p>Each fixbuf application must have a single <a class="el" href="public_8h.html#a7403b5635628fcc24eeb03b73c0b08bd">fbInfoModel_t</a> instance that represents the Information Elements that the application understands. The <a class="el" href="public_8h.html#a23b1973cadfc63b05fabe6091ce48875" title="Allocates a new information model.">fbInfoModelAlloc()</a> call allocates a new Information Model with the IANA-managed information elements (current as of the fixbuf release date) preloaded. Additional vendor-specific information elements may be added with <a class="el" href="public_8h.html#ae06a524366afa6827d7e5abb1c33c0d0" title="Adds a single information element to an information model.">fbInfoModelAddElement()</a>, <a class="el" href="public_8h.html#a202bfa2340263229893a38de18670179" title="Adds multiple information elements in an array to an information model.">fbInfoModelAddElementArray()</a>, <a class="el" href="public_8h.html#af72db51fd417df411a82909c5fd5d84d" title="Adds information specified in the given XML file to the information model.">fbInfoModelReadXMLFile()</a>, and <a class="el" href="public_8h.html#a2bbcf6d4a777ed7e0a2c364e0662b9f3" title="Adds information specified in the given XML data to the information model.">fbInfoModelReadXMLData()</a>.</p>
<p>To create an Exporter, first create an <a class="el" href="public_8h.html#a8441ccbdab7eaccc081dae0e3af32855">fbSession_t</a> attached to the application's <a class="el" href="public_8h.html#a7403b5635628fcc24eeb03b73c0b08bd">fbInfoModel_t</a> to hold the Exporter's Transport Session state using <a class="el" href="public_8h.html#a19d0dfe113d61cdabf601ca79c3049c8" title="Allocates a transport session state container.">fbSessionAlloc()</a>. If exporting via the Spread protocol, create an <a class="el" href="public_8h.html#a170ff9041ad3133df0072d0726284d50">fbSpreadParams_t</a> and set its <code>session</code> member to your newly defined fbSession_t, group names (a null terminated array), and Spread daemon name.</p>
<p>Then create an <a class="el" href="public_8h.html#a054d6ae24ecc9fbc2e38e683d8a5481a">fbExporter_t</a> to encapsulate the connection to the Collecting Process or the file on disk, using the <a class="el" href="public_8h.html#ab3bb271c645c2e346bdf326d128d4495" title="Allocates an exporting process endpoint for an opened ANSI C file pointer.">fbExporterAllocFP()</a>, <a class="el" href="public_8h.html#a66e4d68eeae6049924a00ac884774b42" title="Allocates an exporting process endpoint for a named file.">fbExporterAllocFile()</a>, <a class="el" href="public_8h.html#ac541fea7b2c8077805cc5e70997535b0" title="Allocates an exporting process endpoint for a network connection.">fbExporterAllocNet()</a>, <a class="el" href="public_8h.html#a799054439b578abffa39c0ee8762bea6" title="Allocates an exporting process to use the existing buffer buf having the specified size.">fbExporterAllocBuffer()</a>, or <a class="el" href="public_8h.html#ac423b7914886fe6e7124995f994f6e0b" title="Allocates an exporting process endpoint for a Spread connection.">fbExporterAllocSpread()</a> calls.</p>
<p>With an fbSession_t and an fbExporter_t available, create a buffer (<a class="el" href="public_8h.html#ab1479ebe89aecd202bb628c33102129b">fBuf_t</a>) for writing via <a class="el" href="public_8h.html#a92c9965c452294b11eaf10c34a7f9629" title="Allocates a new buffer for export.">fBufAllocForExport()</a>.</p>
<p>Create and populate templates for addition to this session using <a class="el" href="public_8h.html#ad29df497298e072387af52c3a758f268" title="Allocates a new empty template.">fbTemplateAlloc()</a> and <a class="el" href="public_8h.html#acb8f6399ecdbbc6af8fbacedc4e49a6c" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendSpecArray()</a>, <a class="el" href="public_8h.html#a3507ead494bd3957d325565c66660e79" title="Appends an information element described by specifier to a template.">fbTemplateAppendSpec()</a>, or <a class="el" href="public_8h.html#a06ca9d2de7767f09ddcaa50651ff5b7c" title="Appends an information element to a template.">fbTemplateAppend()</a>). The layout of the template usually matches the C <code>struct</code> that holds the record. Any gaps (due to alignment) in the C <code>struct</code> must be noted in both the data structure and the template.</p>
<p>Example code: </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code hl_struct" href="public_8h.html#structfb_info_element_spec__st">fbInfoElementSpec_t</a> exportTemplate[] = {</div>
<div class="line">    {<span class="stringliteral">&quot;flowStartMilliseconds&quot;</span>,               8, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;flowEndMilliseconds&quot;</span>,                 8, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;octetTotalCount&quot;</span>,                     8, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;packetTotalCount&quot;</span>,                    8, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;sourceIPv4Address&quot;</span>,                   4, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;destinationIPv4Address&quot;</span>,              4, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;sourceTransportPort&quot;</span>,                 2, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;destinationTransportPort&quot;</span>,            2, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;protocolIdentifier&quot;</span>,                  1, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;paddingOctets&quot;</span>,                       3, 0 },</div>
<div class="line">    {<span class="stringliteral">&quot;payload&quot;</span>,                             0, 0 },</div>
<div class="line">    <a class="code hl_define" href="public_8h.html#ae7f1800b8e6f3d6461798f9c9c6127a1">FB_IESPEC_NULL</a></div>
<div class="line">};</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>exportRecord_st {</div>
<div class="line">    uint64_t      flowStartMilliseconds;</div>
<div class="line">    uint64_t      flowEndMilliseconds;</div>
<div class="line">    uint64_t      octetTotalCount;</div>
<div class="line">    uint64_t      packetTotalCount;</div>
<div class="line">    uint32_t      sourceIPv4Address;</div>
<div class="line">    uint32_t      destinationIPv4Address;</div>
<div class="line">    uint16_t      sourceTransportPort;</div>
<div class="line">    uint16_t      destinationTransportPort;</div>
<div class="line">    uint8_t       protocolIdentifier;</div>
<div class="line">    uint8_t       padding[3];</div>
<div class="line">    <a class="code hl_struct" href="public_8h.html#structfb_varfield__st">fbVarfield_t</a>  payload;</div>
<div class="line">} exportRecord_t;</div>
<div class="line"><a class="code hl_struct" href="private_8h.html#structfb_template__st">fbTemplate_t</a> *tmpl = <a class="code hl_function" href="public_8h.html#ad29df497298e072387af52c3a758f268">fbTemplateAlloc</a>(infoModel);</div>
<div class="line"><a class="code hl_function" href="public_8h.html#acb8f6399ecdbbc6af8fbacedc4e49a6c">fbTemplateAppendSpecArray</a>(tmpl, exportTemplate, UINT32_MAX, &amp;err);</div>
<div class="ttc" id="aprivate_8h_html_structfb_template__st"><div class="ttname"><a href="private_8h.html#structfb_template__st">fbTemplate_st</a></div><div class="ttdoc">An IPFIX template or options template structure.</div><div class="ttdef"><b>Definition</b> private.h:208</div></div>
<div class="ttc" id="apublic_8h_html_acb8f6399ecdbbc6af8fbacedc4e49a6c"><div class="ttname"><a href="public_8h.html#acb8f6399ecdbbc6af8fbacedc4e49a6c">fbTemplateAppendSpecArray</a></div><div class="ttdeci">gboolean fbTemplateAppendSpecArray(fbTemplate_t *tmpl, fbInfoElementSpec_t *spec, uint32_t flags, GError **err)</div><div class="ttdoc">Appends information elements described by a specifier array to a template.</div></div>
<div class="ttc" id="apublic_8h_html_ad29df497298e072387af52c3a758f268"><div class="ttname"><a href="public_8h.html#ad29df497298e072387af52c3a758f268">fbTemplateAlloc</a></div><div class="ttdeci">fbTemplate_t * fbTemplateAlloc(fbInfoModel_t *model)</div><div class="ttdoc">Allocates a new empty template.</div></div>
<div class="ttc" id="apublic_8h_html_ae7f1800b8e6f3d6461798f9c9c6127a1"><div class="ttname"><a href="public_8h.html#ae7f1800b8e6f3d6461798f9c9c6127a1">FB_IESPEC_NULL</a></div><div class="ttdeci">#define FB_IESPEC_NULL</div><div class="ttdoc">Convenience macro defining a null information element specification initializer (fbInfoElementSpec_t)...</div><div class="ttdef"><b>Definition</b> public.h:1807</div></div>
<div class="ttc" id="apublic_8h_html_structfb_info_element_spec__st"><div class="ttname"><a href="public_8h.html#structfb_info_element_spec__st">fbInfoElementSpec_st</a></div><div class="ttdoc">A single IPFIX Information Element specification.</div><div class="ttdef"><b>Definition</b> public.h:1815</div></div>
<div class="ttc" id="apublic_8h_html_structfb_varfield__st"><div class="ttname"><a href="public_8h.html#structfb_varfield__st">fbVarfield_st</a></div><div class="ttdoc">A variable-length field value.</div><div class="ttdef"><b>Definition</b> public.h:1236</div></div>
</div><!-- fragment --><p>The <code>flags</code> member of <a class="el" href="public_8h.html#structfb_info_element_spec__st">fbInfoElementSpec_st</a> allows creation of multiple templates from a single spec array. The template-building functions <a class="el" href="public_8h.html#a3507ead494bd3957d325565c66660e79" title="Appends an information element described by specifier to a template.">fbTemplateAppendSpec()</a>, <a class="el" href="public_8h.html#acb8f6399ecdbbc6af8fbacedc4e49a6c" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendSpecArray()</a>, and <a class="el" href="public_8h.html#a373baa2368284e89bd58b5f9643b6222" title="Determines if a template contains at least one instance of each information element in a given inform...">fbTemplateContainsAllFlaggedElementsByName()</a> take a parameter also named <code>flags</code>. If an <a class="el" href="public_8h.html#a337ab69da423d123e6947eed140d80e2">fbInfoElementSpec_t</a>'s <code>flags</code> is 0, the spec is always used. When the spec's <code>flags</code> is non-zero, the spec is used only if spec's <code>flags</code> intersected with (bit-wise AND) the function's <code>flags</code> parameter equals the spec's <code>flags</code>. That is, the high bits of the <code>flags</code> parameter must include all the high bits of the spec's <code>flags</code>. In general, the <code>flags</code> member of an <a class="el" href="public_8h.html#a337ab69da423d123e6947eed140d80e2">fbInfoElementSpec_t</a> should have few high bits. The functions' <code>flags</code> parameter generally contains multiple high bits to include multiple specs. Consider this spec array:</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="public_8h.html#structfb_info_element_spec__st">fbInfoElementSpec_t</a> spec_array[] = {</div>
<div class="line">    {<span class="stringliteral">&quot;protocolIdentifier&quot;</span>,       1,  0},</div>
<div class="line">    {<span class="stringliteral">&quot;paddingOctets&quot;</span>,            3,  8},</div>
<div class="line">    {<span class="stringliteral">&quot;sourceTransportPort&quot;</span>,      2,  1},</div>
<div class="line">    {<span class="stringliteral">&quot;destinationTransportPort&quot;</span>, 2,  1},</div>
<div class="line">    {<span class="stringliteral">&quot;paddingOctets&quot;</span>,            5, 16},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpTypeIPv4&quot;</span>,             1,  2},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpCodeIPv4&quot;</span>,             1,  2},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpTypeIPv6&quot;</span>,             1,  4},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpCodeIPv6&quot;</span>,             1,  4},</div>
<div class="line">    <a class="code hl_define" href="public_8h.html#ae7f1800b8e6f3d6461798f9c9c6127a1">FB_IESPEC_NULL</a></div>
<div class="line">};</div>
</div><!-- fragment --><p>The protocol is included in every template since the <code>flags</code> member value is 0. The ports are included when the <code>flags</code> parameter is 1. When building a template that maps to the following C <code>struct</code> (where padding is necessary for member alignment), the <code>flags</code> parameter should be 9.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>proto_ports = {</div>
<div class="line">    uint8_t   protocol;</div>
<div class="line">    uint8_t   padding[3];</div>
<div class="line">    uint16_t  source_port;</div>
<div class="line">    uint16_t  dest_port;</div>
<div class="line">};</div>
</div><!-- fragment --><p>For ICMP records, the <code>flags</code> parameter should be 2 or 4 depending on whether the record is IPv4 or IPv6, respectively. To map the template to the following <code>struct</code>, the <code>flags</code> parameter should be 18 for IPv4 and 20 for IPv6.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>proto_ports = {</div>
<div class="line">    uint8_t   protocol;</div>
<div class="line">    uint8_t   padding[5];</div>
<div class="line">    uint8_t   icmp_type;</div>
<div class="line">    uint8_t   icmp_code;</div>
<div class="line">};</div>
</div><!-- fragment --><p>Add the templates to the session via <a class="el" href="public_8h.html#a2e4baf6d2142eca4cb526b1e80628bf8" title="Adds a template to a session.">fbSessionAddTemplate()</a> or <a class="el" href="public_8h.html#a818c3ca59f631a80062a8ccc20748c2a" title="Adds a template to the session, as fbSessionAddTemplate(), with the provided metadata.">fbSessionAddTemplateWithMetadata()</a>.</p>
<p>If exporting via Spread, before calling <a class="el" href="public_8h.html#a2e4baf6d2142eca4cb526b1e80628bf8" title="Adds a template to a session.">fbSessionAddTemplate()</a>, set the group that should receive this template with the <a class="el" href="public_8h.html#a3c93bca4f6e239e7712fafaa8f1beefb" title="This function checks to see if the groups you are setting on the buffer are different than the groups...">fBufSetSpreadExportGroup()</a> call. If more than 1 group should receive the template, use the <a class="el" href="public_8h.html#a183ad2821b346332f83e3e0dc72ba284" title="Sets and sends templates for 1 or more groups.">fbSessionAddTemplatesMulticast()</a> which will call <a class="el" href="public_8h.html#a3c93bca4f6e239e7712fafaa8f1beefb" title="This function checks to see if the groups you are setting on the buffer are different than the groups...">fBufSetSpreadExportGroup()</a> on the given group(s) multicast the template to the given group(s). For Spread, do not use <a class="el" href="public_8h.html#a2e4baf6d2142eca4cb526b1e80628bf8" title="Adds a template to a session.">fbSessionAddTemplate()</a> to send to multiple groups.</p>
<p>Typically each template is added to the session twice, once as an internal template---which describes how the record appears in memory---and again as an external template---which describes how the record appears in the IPFIX message.</p>
<p>Templates use internal reference counting, so they may be added to multiple sessions, or to the same session using multiple template IDs or multiple domains, or as both an internal and an external template on the same session.</p>
<p>Once the templates have been added to the session, use <a class="el" href="public_8h.html#a4e0c42fc80985c048190203257697ab6" title="Exports all external templates in the current domain of a given session.">fbSessionExportTemplates()</a> to add the templates to the buffer and then set the internal and external template IDs with <a class="el" href="public_8h.html#a28c6c56234351a793fd513b212bd31b8" title="Sets the internal template on a buffer to the given template ID.">fBufSetInternalTemplate()</a> and <a class="el" href="public_8h.html#af6cd20b1eb9a3287f17587888ee2476b" title="Sets the external template for export on a buffer to the given template ID.">fBufSetExportTemplate()</a>. You can then use <a class="el" href="public_8h.html#ad3fdaa8626ff753c5b617707698c22b6" title="Appends a record to a buffer.">fBufAppend()</a> to write records into IPFIX Messages and Messages to the output stream.</p>
<p>If using Spread, call <a class="el" href="public_8h.html#a3c93bca4f6e239e7712fafaa8f1beefb" title="This function checks to see if the groups you are setting on the buffer are different than the groups...">fBufSetSpreadExportGroup()</a> to set the groups to export to on the buffer before calling <a class="el" href="public_8h.html#ad3fdaa8626ff753c5b617707698c22b6" title="Appends a record to a buffer.">fBufAppend()</a>.</p>
<p>By default, <a class="el" href="public_8h.html#ad3fdaa8626ff753c5b617707698c22b6" title="Appends a record to a buffer.">fBufAppend()</a> will emit an IPFIX Message to the output stream when the end of the message buffer is reached on write. The <a class="el" href="public_8h.html#a661f4cc21e726345d3e22372af33c2d1" title="Sets the automatic (read/write) mode flag on a buffer.">fBufSetAutomaticMode()</a> call can be used to modify this behavior, causing <a class="el" href="public_8h.html#ad3fdaa8626ff753c5b617707698c22b6" title="Appends a record to a buffer.">fBufAppend()</a> to return FB_ERROR_EOM when at end of message. Use this if your application requires manual control of message export. In this case, <a class="el" href="public_8h.html#a3def007c235fd0dccb7a2293b23341e1" title="Emits the message currently in a buffer using the associated exporting process endpoint.">fBufEmit()</a> will emit a Message to the output stream. If your exporter was created via <a class="el" href="public_8h.html#a799054439b578abffa39c0ee8762bea6" title="Allocates an exporting process to use the existing buffer buf having the specified size.">fbExporterAllocBuffer()</a>, you may use <a class="el" href="public_8h.html#a9d50a75267c63f2a3c12b2118714c16f" title="Gets the (transcoded) message length that was copied to the exporting buffer upon fBufEmit() when usi...">fbExporterGetMsgLen()</a> to get the message length.</p>
<p>If not in automatic mode and a session's templates do not fit into a single message, use <a class="el" href="public_8h.html#a9236bdb53a94cd19bad3fef2c9bfb947" title="Exports a single external template in the current domain of a given session.">fbSessionExportTemplate()</a> to export each template individually instead of relying on <a class="el" href="public_8h.html#a4e0c42fc80985c048190203257697ab6" title="Exports all external templates in the current domain of a given session.">fbSessionExportTemplates()</a>.</p>
<p>Manual control of message export is incompatible with template and information element metadata (<a class="el" href="public_8h.html#a8c074192377fd4089feef07f52183449" title="Configures a session to export template metadata as options records.">fbSessionSetMetadataExportTemplates()</a> and <a class="el" href="public_8h.html#a2e729b270df473a1f32f519ed184a259" title="Configures a session to export type information for enterprise-specific information elements as optio...">fbSessionSetMetadataExportElements()</a>). There are several functions that may cause the metadata options records to be exported, and the session must be free to create a new record set or template set as needed. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</body>
</html>
